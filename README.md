# 📘 Git プロジェクト初期化 & 運用手順（テンプレート）

## 🧱 初回プロジェクト作成時（GitHubと連携するまで）

1. プロジェクトディレクトリを作成
```bash
mkdir your_project_name
cd your_project_name
```

2. 仮想環境を構築
```
python -m venv venv
source venv/bin/activate  # Windowsは .\venv\Scripts\activate
```

3. Gitを初期化
```
git init
```

4. .gitignoreを作成
```
venv/
__pycache__/
*.pyc
.DS_Store
```

5.README.mdの作成
```
touch README.md
```

6.GitHubで新規リポジトリを作成
 - 右上の＋ボタンからNew repositoryを押下
 - 「READMEを初期化」のチェックは外す

7.GitHubとリモート接続
```
git remote add origin https://github.com/yourusername/your_project_name.git
git branch -M main
```

8.最初のコミット&push
```
git add .
git commit -m "Initial commit"
git push -u origin main
```

## 🔁以降の運用（変更を保存するたびに）
1.変更をステージに追加
```
git add .
```

2.コミットする
```
git commit -m "ここに変更内容を書く"
```

3.GitHunへ反映(push)
```
git push
```

# 🚀開発のロードマップ(Backend)

## 🔷 ステージ 1：コアスクリーニングエンジンの実装
🎯 目的：
複数の東証上場株式を取得し、移動平均線(EMA5,EMA20,EMA40)を計算し、6つのステージに分類できること。

🗃️ ディレクトリ構成
```
stock_screening_app/
├── main.py                 ← 起動ファイル
├── TickerLoader.py         ← data_j.xlsをloadし、yfinanceで利用できるように前処理するクラス
├── StockDataFetcher.py     ← yfinanceから株価を取得し、EMAを計算するクラス
├── StageAnalyzer.py        ← ステージを判定するクラス
├── BatchScreening.py       ← スクリーニングを実行し、キャッシュとして保存しておく。
├── requirements.txt
└── README.md
```
## 🔷 ステージ 2：Web UIの構築（ステージ選択UI）
🎯 目的：
「大循環分析」セクションに、ステージ1〜6のチェックボックスを用意し、該当銘柄を一覧表示する画面を構築

✅ タスク：

 HTML + JSベースのUI（例：Bootstrap + Vanilla JS）

 ステージ1〜6のチェックボックスを配置

 チェックボックスの状態をもとにAPIを呼び出し

 結果を表形式で描画（銘柄コード、銘柄名、ステージなど）

 チャートページ（Yahooなど）へのリンクも追加

🖥️ フロントエンドのUIイメージ（ざっくり）
```
[市場]
[]東証プライム市場
[]東証スタンダード市場
[]東証グロース市場

[出来高]
【下限】~ 【上限】

 [ 移動平均線大循環分析 ]
[✔] ステージ1
[✔] ステージ2
[ ] ステージ3
[ ] ステージ4
[✔] ステージ5
[ ] ステージ6

[ 検索ボタン ]

--- 結果 ---
| 銘柄コード | 銘柄名 | 直近出来高　|　直近終値　|現在のステージ |　 チャートリンク |
|------------|--------|----------|-----------|----------------|----------------|
| 7203       | トヨタ | 40000　　|　　2,500　　|　　ステージ1    | [リンク]       |
| 9984       | ソフトバンクG | 40000|2,500　　|　　ステージ1    | [リンク] |
```

## 🔷 ステージ 3：ステージ別データキャッシュ・JSON生成
🎯 目的：
全銘柄の大循環分析を定期実行しておき、結果をAPIで即返せるようにする。現状では、検索するたびにすべての銘柄のスクリーニングを実施しているため、時間がかかるのに対して、キャッシュを使うことでスクリーン済の結果をすぐ返却できるようになる。

✅ タスク：
 スクリーニングバッチ（例：BatchScreening.py）作成
 * 全銘柄のステージを一括判定し、JSONファイルで保存する。
 ```
 output/
└── screening_result.csv   ← 日付別キャッシュ（オプション）
 ```

## 🔷 ステージ 4：定期スクリーニングの自動実行（GitHub Actionsなど）
🎯 目的：
株価データは日々変わるため、毎日朝に自動スクリーニングを行い、最新結果を保存する。

✅ タスク：

 batch_screening.py をGitHub Actionsやcronで自動実行
   * data_j.xlsの上場銘柄の一覧の最新化　⇒　最新化され次第？※ここをどう最新化するか・・
   * output/のスクリーニング結果の最新化　⇒ 1日1回？

 結果ファイルを data/ に更新

 必要に応じて差分チェックやログ出力も整備

 ## 🔷 ステージ 5：Discord連携機能の実装
🎯 目的：
Webhookを用いて、Pythonから通知を送る。

✅ タスク：

### Discord通知システム構築
- Discordサーバーを作成（または既存を使用）
- 通知用チャンネルを作成
- Webhookを発行

## 🔷 ステージ 6：分析機能の拡張
🎯 目的：
移動平均線大循環分析に基づいた株のスクリーニングに終始した現状のUI分析から、売買の半自動化の機能拡張を目指す。下記の機能を持ったシステムを作りたい。
   * 前提条件、テクニカル分析に基づき、買う（売る）べき銘柄を通知する。
   * 実際に保有した場合、画面から登録する。その際に必要な情報を登録する。
   * 保有している銘柄が利確のタイミングとなったら通知する。
   * 売ったら画面から保有銘柄を削除し、その銘柄の利確通知は今後行わない。

### UI、通知イメージとフロー整理
   0. 前提となる銘柄スクリーニング条件設定UI
   ```
   【市場】
   ☐プライム市場
   ☐スタンダード市場
   ☒グロース市場
   
   【予算】
   下限～上限

   【出来高】
   下限～上限
   
   ```
   1. 銘柄選定Discord通知
```
         💰本日のおすすめの銘柄一覧を通知します💰

         【📈買いのおすすめ📈】
         銘柄　　　　　　　　　スコア　　　　逆指値エントリー金額　　　　ロスカット金額
         4722:フューチャー　　　70点　　　　2,200円　　　　　　　　　　　2,150円

         【📉空売りのおすすめ📉】
         銘柄　　　　　　　　　スコア　　　　逆指値エントリー金額　　　　ロスカット金額
         3407:旭化成　　　　　70点　　　　　1,000円　　　　　　　　　　　1,150円

```
   2. 保有設定
```
～～～エントリー設定～～～
【対象銘柄】
【購入価格】※できるだけ項目は減らし、バックエンドで取得して保存したい。
                                                                        保存
```
   3. 利益確定Discord通知
```
         ‼️売り時が来ました‼️
         あなたの保有する銘柄を下記の条件で売ってください。

         銘柄　　　　　　　　　注文区分　　　　　　　　金額
         4722:フューチャー　　売り注文　　　　　　　　2,300円
         3407:旭化成　　　　　返済注文　     　　　　成行
```

   4. 完了設定
   ```
   ～～～保有銘柄一覧～～～
銘柄コード    銘柄名    
4722         Future     【利確ボタン】
   ```
 ### 要件定義
 0. DB環境構築
* SQLite導入

 1. 売買すべき銘柄のスクリーニング～通知機能
      * 共通条件
         * 出来高が極端に少ない銘柄は回避する。
            * 75日平均出来高が10万を下回る銘柄は除外
         * 決算直前（10営業日以内）の銘柄は回避する。

      * 買うべき銘柄の条件
         * 大循環分析
            * ステージ1
            * 3本とも上昇傾向にある。傾きがプラス
            * 短期EMAが中期EMAの上回った直後

         * 出来高
            * 当日の出来高が5日or20日平均を1.5倍以上であること

         * ローソク足の形状
            * エントリー当日に、5日EMAをサポートしている(株価が5日EMA付近まで下がり、陽線で反発しているということ)
         
         * ボリンジャーバンド
            * 終値が+1σより僅かに上にあること
         
      * 買いのエントリーポイント
         * 短期EMAの押し目買い
         * 押し目が入らない場合、直近高値のブレイクポイント

      * 空売りすべき銘柄の条件
         * TBD

      * 出口戦略としてのロスカット設定
         * 現在値 - 1.5ATR
         * キリの良い数字(10の位を四捨五入)
         * 日次の更新時は現在の値よりも下回らないこと

            Ex) 現値：1365円、1.5ATR:101円、損切ライン：1264円⇒1250円

 2.  利確すべきタイミングの条件～通知
      * 売りのタイミング
         1. 固定利幅(2ATR&1の位を四捨五入したキリの良い数字)で即利確※絶対条件①

         2. トレーリングストップ※絶対条件②
         * 購入後の最高値を最大利益点と定義する。以降、それを更新した場合は最高点を更新する。
         * また、ATRは購入した時点の断面を保持しておく。
         * 現在価格 = 最大利益点 + 1ATR以下となった場合、即決済

      * 下記の条件のうち3つ満たした場合、利確

         3. ステージ転換
            * トレンド転換の兆候があれば、目標未達でも利確。
            * EX) ステージ1⇒ステージ2
         
         4. RSI
            * RSI >= 70
            * そこからRSIが2日連続下降

         5. ボリンジャーバンド
            * +2σに到達
            * RSI>=70も並行
         
         6. MACD
            * MACDラインがシグナルラインを下回る（デッドクロス）

         7. 出来高の急減
            * 本日の出来高が5日or20日の平均出来高の半分である場合
            * 小陽線or小陰線

      * 買い戻し（返済注文）のタイミング

         1. TBD

### DB設計

* スクリーニングの前提情報を管理するDB
1. investment_prerequisites：スクリーニングの前提条件を管理するDB
   * UIから前提条件を受け取り、このDBに保持しておく。スクリーニング前にこのDBを参照し、スクリーニングを行うイメージ
```
カラム名             |        型　       |    説明
id                         INTEGER           主キー
market_segment             TEXT              市場選択（プライム市場、スタンダード市場などをカンマ区切りで保持？）※いいアイデア浮かばず
volume_lower_limit         INTEGER           出来高の下限
volume_upper_limit         INTEGER           出来高の上限
budget_lower_limit         INTEGER           予算の下限
budget_upper_limit         INTEGER           予算の上限
```

* 分析前の銘柄を管理するDB
2. stocks:東証上場銘柄一覧のxlsをそのまま保持する。スクリーニング対象銘柄はここから取得する。
```
| カラム名        | 型       | 必須  | 説明                    |
| ----------- | ------- | --- | --------------------- |
| id          | INTEGER | Yes | 主キー（自動インクリメント）        |
| code        | TEXT    | Yes | 銘柄コード（例: 7203）        |
| name        | TEXT    | Yes | 銘柄名（例: トヨタ自動車）        |
| market      | TEXT    | Yes | 市場（例: プライム, スタンダードなど） |
| sector      | TEXT    | No  | 業種名                   |
| created_at | TEXT    | Yes | データ登録日（例: 2025-07-30） |
| updated_at | TEXT    | No  | データ更新日                |

```

* 分析結果を管理するDB（売買通知の核）※最重要

3. buy_sell_analysis:1日2回のスクリーニングの分析結果を保持するテーブル。このテーブルには売買、ロスカット、利益目標を算出するのに必要な情報を保持する。
```
| カラム名               | 型       | 必須    | 備考・用途                                   |
| --------------------- | ------- | ----- | --------------------------------------- |
| id                    | INTEGER | ◯（PK） | 自動採番の主キー                                
| code                  | TEXT    | ◯     | 銘柄コード（例：7203.T）                         
| name                  | TEXT    | ✕     | 銘柄名                                     
| market                | TEXT    | ◯     | 市場名　例：プライム、スタンダード、グロース               
| date                  | TEXT    | ◯     | 分析を行った日付（YYYY-MM-DD）                    
| topix_stage           | INTEGER | ◯     | 地合いを見る目的でTOPIXの移動平均線大循環分析によるステージ（1〜6）                  
|topix_ema5             | REAL    | 〇     | TOPIXの5日EMA
|topix_ema20            | REAL    | 〇     | TOPIXの20日EMA
|topix_ema40            | REAL    | 〇     | TOPIXの40日EMA
|stock_stage            | INTEGER | ◯     | 対象銘柄のステージ
|stock_ema5             | REAL    | 〇     | 対象銘柄の5日EMA
|stock_ema20            | REAL    | 〇     | 対象銘柄の20日EMA
|stock_ema40            | REAL    | 〇     | 対象銘柄の40日EMA
|rsi                    | REAL    | ◯     | RSI値※幅は？                            
|rsi_delta              | REAL    | ◯     | 前日比でのRSI変化量（例：-1.5）                     
|macd                   | REAL    | ◯     | MACDラインの値（5日EMA - 20日EMA）                                
|macd_signal            | REAL    | ◯     | MACDシグナル(9日EMA)                             
|macd_histogram         | REAL    | ◯     | MACDヒストグラム(MACD - シグナル)                              
|recent_golden_cross    | BOOLEAN | ◯     | 3営業日以内にMACDがシグナルを上抜けた直後である場合、True    
|recent_dead_cross      | BOOLEAN | ◯     | 3営業日以内にMACDがシグナルを下抜けた直後である場合、True    
|atr                    | REAL    | ◯     | 当日のATR              
|closing_price          | REAL    | ◯     | 終値                                
|price_max_since_buy    | REAL    | ✕     | 買付以降の最高値（利確条件に使用）                       
|bb_plus_1sigma         | REAL    | ◯     | ボリンジャーバンドの1σの値
|bb_plus_2sigma         | REAL    | ◯     | ボリンジャーバンドの2σの値
|bb_minus_1sigma        | REAL    | ◯     | ボリンジャーバンドの-1σの値
|bb_minus_2sigma        | REAL    | ◯     | ボリンジャーバンドの-2σの値                         
|volume                 | REAL    | ◯     | 当日の出来高                                                           
|volume_avg_5d          | REAL    | ◯        | 過去5営業日の平均出来高
|volume_avg_20d         | REAL    | ◯       | 過去20営業日の平均出来高 
|obv                    | REAL    | ◯       | 当日のobv
|obv_pre_1              | REAL    | ◯       | obvの1日前の値
|obv_pre_2              | REAL    | ◯       | obvの2日前の値
|obv_pre_3              | REAL    | ◯       | obvの3日前の値
|obv_ma_20              | REAL    | ◯       | obvの20日移動平均
|latest settlement date | TEXT    | ✕       | 直近の決算日                                              
|create_day             | TEXT    | ◯       | レコード作成日時（タイムスタンプ：YYYY-MM-DD HH\:MM\:SS） 

```

* 保有している銘柄を管理するDB（利確通知の核）※重要
4. holding_stocks:保有銘柄の情報、およびロスカットや利確条件を管理するDB。株式市場が動いている15分に1回更新する。利確のタイミングになり次第、通知を行う。
```
| カラム名               | 型       | 必須    | 備考・用途                                   
| --------------------- | ------- | ----- | ---------------------------------------
| id                    | INTEGER | ◯（PK） | 自動採番の主キー
| position              | TEXT    | 〇       | 買いor売り（空売り）※UIから貰う                                
| code                  | TEXT    | ◯       | 銘柄コード（例：7203.T）                         
| name                  | TEXT    | ✕       | 銘柄名
| market                | TEXT    | ◯       | 市場名　例：プライム、スタンダード、グロース  
| loss_price            | REAL    | 〇       | 現時点の想定ロスカット金額
| target_price          | REAL    | 〇       | 購入時点での目標金額（2ATR）
| buy_price             | REAL    | 〇       | 購入金額
| buy_date              | TEXT    | 〇       | 約定日
| possession_flag       | BOOLEAN | 〇       | 現在保有中かどうかを管理するフラグ。TRUEの場合、保有中。
| create_day            | TEXT    | ◯       | レコード作成日時（タイムスタンプ：YYYY-MM-DD HH\:MM\:SS） 
```

### 実装手順
* 保有銘柄管理、および利確通知機能
   
1. DB（holding_stocks）作成
   
   * DBを作成し、クライアントツールで触れるまでがゴール
   * db/に作成

2. UI作成
   * 目的
      * 保有している銘柄の作成と破棄

3. LossCutUpd.py作成（新たに設定すべきロスカット金額の計算を行うクラス）
   
   * 保有している銘柄（possession_flagがTRUE）のレコードを対象に、新しいロスカット金額を通知する。
   * Github ACtionsのジョブフローを1日1回、市場終了（15時半）以降に自動実行する。

   * ロスカットの更新条件は下記の通り
   ```
   ・エントリー価格 - 2*ATRを四捨五入する。
   ・売りの場合は-を+にするだけ。
   ・ただし、現在のロスカット金額を下回らないこと
   ・売りの場合は上回らないこと
   ```

4. LockInProfits.py(利益確定のタイミングになっていないかを計算するクラス)


* 買うべき（空売りすべき）銘柄の分析および通知機能

   ⇒核となる銘柄選定条件が若干検討の余地があるため、一旦stay